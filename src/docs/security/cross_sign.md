---
title: 交叉认证
order: 3
---

如果您对非对称加密有所耳闻，那么您一定知道非对称加密难以抵抗“中间人攻击”。Matrix也不例外暴露在这种攻击的威胁下。在TLS中，解决中间人攻击的措施和手段是“公钥签名”，但Matrix协议中显然不能这么做。Matrix的信任模型中，您永远不能相信为您提供服务的服务器是可信的，如果服务器对您的客户端进行中间人攻击，可以轻易的介入您和对方的加密聊天，获得所有数据。

为了确保对方发送过来的公钥完全来源于对方而不是中间人，你们需要一个额外的、不受中间人控制的受信任的环境来对比密钥。在Matrix中，你们可以通过在其他渠道里比对在双方生成的Emoji图片的顺序来完成整个确认过程。如果双方生成的图片顺序相同，就说明双方都是可以信任的。在比对之后，双方就可以使用这个安全的公钥来发送各种非对称消息，

## 公钥签名

不过，如果每个人都互相比对一遍和自己聊天所有人的密钥，相当困难而且不现实。为了快速建立全服务器的公钥信任体系，Matrix引入了“交叉认证”机制。您A可以主动申请认证一个人B的公钥，检查自己A收到的公钥是否与对方B的实际公钥一致。如果一致，就对对方B的公钥进行签名，下次对方B再向其他人C发送公钥的时候，可以带上这个签名，如果那个人也信任这个签名的人A（也就是您自己），那么这个人C可以理所应当的信任B的公钥，这样BC就不需要重复AB的认证过程，可以建立起稳定的信任了。

NerChat!的服务端采用synapse部署，保证不会进行中间人攻击，不过为了保险期间，推荐大家还是互相认证一下。为了认证一个人的设备，需要用到“设备认证”功能，下面会详细介绍认证设备的方法，推荐大家掌握。

## 设备认证

如果你想认证一个人的设备，你至少需要拥有自己的Megolm密钥库，所以需要先提供安全密钥验证自己的设备。关于验证设备的方法请参考[导入安全密钥](secure_key/#加载安全密钥)。当你想验证一个用户的时候，请确保自己和这个用户有除了NerChat!之外的第二个通信渠道，比如电子邮件、其他的社交平台、或者一个稳定的视频连接，当然最推荐的是线下直接见面，这个渠道被用来分享自己的emoji表情，和对方比对是否一致。

::: tabs#client

@tab Web

在你和要验证的用户的聊天中点击那个人的头像，可以看到他的所有设备及其验证情况。标记为绿色的设备是经过验证的设备，标记为灰色的是没有经过您的但是经过其他人验证的设备，标记为红色的是没有经过任何人验证的设备，是不可信任的设备。

- 您可以点击聊天室的“验证”按钮，来直接在会话中验证对方的设备，这是推荐的方法。

    1. 点击聊天信息按钮，在菜单里点击“验证”。

        ![](/nerchatguide/web/start_verify.png)
    
    2. 点击“开始验证”开始两个人的验证过程。您此时最好已经做好和对方用另一种方式聊天的准备。

        ![](/nerchatguide/web/auth_request.png)

        ![](/nerchatguide/web/auth_request_chat.png)

        您可以“接受”弹出的“已请求验证”通知，也可以点击聊天记录里出现的“想要验证”消息的“接受“按钮来接受验证，两种方法是一样的。

    3. 两人中的任何一方都可以主动点击“通过表情符号验证”按钮发起验证。

        ![](/nerchatguide/web/auth_via_emoji.png)
    
    4. 通过可靠渠道比对二人生成的emoji表情序列，看看他们是否相同。如果相同，则说明会话安全，没有中间人，验证通过，可以用这个临时建立的可信加密通道交换公钥了。如果不同……放心不可能不同的。NerChat!绝对安全，同时我们对您的加密聊天内容完全不感兴趣，不会进行中间人攻击，您永远可以信任我们的服务器。

        ![](/nerchatguide/web/emoji_compare.png)

    5. 两人均点击“他们匹配”之后，整个验证流程就结束了。

    验证结束之后，一个可靠的加密通道就顺利建立起来了。两人会用这个通道建立一个临时的连接，交换公钥互相签名认证对方的身份，以后的聊天就可以通过这个可信的密钥进行了。

- 您还可以点击灰色或红色的设备，然后在窗口中选择“文本”或者“emoji”以开始验证对方的某个设备，验证流程如下。

    1. 点击聊天信息按钮，在菜单里点击对方的头像，在对方的信息页面里点击“x个会话”，展开设备列表。选择一个灰色或红色的设备来开始验证。

        ![](/nerchatguide/web/start_device_verify.png)

        ![](/nerchatguide/web/choose_device.png)

    2. 在弹出的对话中选择“以文本形式验证”或“以emoji形式验证”二者的原理相同，不过比起emoji，文本在互联网上的传输更加容易一些。

@tab Mobile

在移动端，您可以验证一个加密聊天的安全性，方法同样也非常简单。

:::