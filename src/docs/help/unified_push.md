---
title: 统一推送原理
order: 2
---
## 什么是统一推送

统一推送是一套规范和工具，可让用户选择推送通知的发送方式。全部采用免费和开源方式。

主要有以下几种:

- `ntfy`
- `GCM/FCM`
- `NextPush`

任何应用都是通过统一推送将消息通知发送到手机，手机收到推送后发出系统广播，应用收到广播通知，再唤醒后台应用，完成消息提示。

## 什么是Matrix推送？

Matrix推送是用来通知手机端用户消息的一种通知手段，常见的推送方式包括Firebase Cloud Messaging(FCM)和三方开源的`ntfy.sh`推送。当这些推送服务无法通信时，则会造成终端无法实时接收消息。

## Matrix推送原理

![](./unified_push.svg)

### `Nelement`如何从HomeServer获取消息

从官方介绍中我们可以了解到，获取原理是由`Nelement`定期调用API(`sync`)，以此来获取服务器状态得到消息。

API底层使用`HTTP`协议完成，同步API则使用`HTTP`长轮询机制。(即客户端与服务端进行长期的`HTTP`连接)

### `Nelement`如何接收推送通知

推送通知本身是用于在某些场景下唤醒应用进行重要信息的快速处理的一种方式。

一般情况下，为了获取通知，`Nelement`会依赖于**推送通知服务**。(例如，上述[统一推送](#什么是统一推送)中介绍的内容)

### 推送原理介绍

假设一个使用场景，用户A和用户B均使用`FCM`推送，以下是用户A向用户B发送消息的过程:

1. A客户端向`Matrix Home Server`发送消息事件。
2. `Matrix Home Server`收到消息后，将通知事件推送给`Push Gateway`。
3. `Push Gateway`从数据库中查询到推送目标用户(用户B)的`Push Provider`信息，推送给对应的`Push Provider`。
4. `Push Provider`收到消息后，就会与用户B的终端进行通信，告知终端推送内容。

> 额外说明：
>  1. 当其中任意一个环节无法完成时，推送就会失败。
>  2. `Push Provider`信息来自用户终端，当用户设置通知方式时，会将注册得到的`Push Provider`信息发送给`Matrix Home Server`进行留存
>  3. 在大陆内使用`Google`通知时，会因无法通知到`Google Push Provider`造成推送失败。
>  4. 终端中的测试推送也是如此，由于测试推送是由终端自行构造推送请求发送给`Push Gateway`。因此在大陆内，测试推送环境也会失败（若可以访问`Google`服务则不会）。

### 后台接收不到通知？

1. 考虑使用`ntfy.sh`推送。(也可自行部署`ntfy.sh`推送服务)
2. 对自部署的`Push Gateway`设置有效的通信环境(自己去想)
3. 大陆手机针对FCM有优化和限制，因此无法使用，建议参考选项1